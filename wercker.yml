box: node:9

build:
  steps:
    - npm-install

    - script:
      name: build
      code: |-
        npm run build

    - script:
      name: artifacts
      code: |-
        mv "$WERCKER_SOURCE_DIR/dist" "$WERCKER_OUTPUT_DIR/"
        mv "$WERCKER_SOURCE_DIR/assets" "$WERCKER_OUTPUT_DIR/"
        mv "$WERCKER_SOURCE_DIR/index.html" "$WERCKER_OUTPUT_DIR/"

deploy:
  steps:
    - install-packages:
      packages: rsync

    - add-to-known_hosts:
      fingerprint: de:67:f2:0c:05:04:f0:33:de:b2:eb:d9:1c:d9:a7:d6
      hostname: 185.201.144.128
      local: true
      type: ecdsa

    - add-ssh-key:
      keyname: SSH_KEY
      host: 185.201.144.128

    - script:
      name: sending files
      code: |-
        rsync -arz "$WERCKER_SOURCE_DIR/" "insider@185.201.144.128:/opt/insider/tanktaler-insider-program-fe_${WERCKER_GIT_COMMIT}"
        ssh insider@185.201.144.128 "rm -rf /opt/insider/tanktaler-insider-program-fe_backup"
        ssh insider@185.201.144.128 "cd /opt/insider; mv tanktaler-insider-program-fe tanktaler-insider-program-fe_backup && mv tanktaler-insider-program-fe_${WERCKER_GIT_COMMIT} tanktaler-insider-program-fe"

    - script:
      name: killing temporary server
      code: |-
        ssh insider@185.201.144.128 "pkill -e -f 'SimpleHTTPServer' || true"

    - script:
      name: starting temporary server
      code: |-
        ssh insider@185.201.144.128 "cd /opt/insider/tanktaler-insider-program-fe; nohup python -m SimpleHTTPServer 8080 >> /tmp/tanktaler-insider-program-fe.log 2>&1 </dev/null &"
